# Minecraft for Docker
マイクラサーバーを簡単に建てるために作成しました。
### Webブラウザからサーバーをコントロールする
　サーバーを遠隔で操作するツールとして[RCON(Remote Controll)](https://github.com/Tiiffi/mcrcon.git)を使用しています。Webブラウザから指定されたコマンドがPythonスクリプトからRCONを通してサーバーへ送信されるようになっています。
詳しい使い方は上記リンクGithubリポジトリを参照してください。  
### 環境変数
必要な環境変数を追加するために、compose.ymlファイル直下にenvファイルを作成し、以下の通り環境変数を設定してください。値は各環境に合ったものを設定してください。
| 変数名 | 使用サービス | 目的 |
| --- | --- | --- |
| MCRCON_HOST | webcon, mcserver | RCONが接続する接続先ホスト名 |
| MCRCON_PORT | webcon, mcserver | RCONの接続先ポート番号 |
| MCRCON_PASS | webcon, mcserver | RCONのログインに使用するパスワード |
| MYSQL_ROOT_PASSWORD | db | MySQLのルートパスワード |
| MYSQL_DATABASE | db | MySQLのデータベース名 |
| MYSQL_USER | db | MySQLのユーザー名 |
| MYSQL_PASSWORD | db | MySQLのユーザーパスワード |
| default_timezone | db | MySQLコンテナのタイムゾーン |

> [!NOTE]
> envファイルは外部に公開するとセキュリティ上の問題があるためリポジトリに含まれていません。必ずクローン後に自身の環境に合わせて作成してください。

> [!WARNING]  
> envファイルを配置しないままコンテナを起動した場合、各コンテナが正常に起動しません。必ず配置してからコンテナを起動してください。

### 実行手順
1. Gitからコードを引っ張る
2. compose.ymlファイルが存在するディレクトリをカレントディレクトリにする
    - PowerShellで必ずカレントディレクトリを上記に移動してください。Macでも同じですが手順は自身で調べて下さい。
    - ローカルPCには事前にDocker Desktopをインストールしておいてください。インストール手順については[こちら](https://www.docker.com/products/docker-desktop/)を参考にしてください。

3. 環境変数を渡すファイルを作成する
    - カレントディレクトリ内に.envファイルを作成し、そこへ必要な環境変数を記述してください。必須の環境変数については本書の環境変数の項目にある表を読んでください。必要に応じて環境変数を増やすことはできますが、必須の環境変数のみで問題なく動作します。
    - 必須の環境変数を記述せずにコンテナを起動した場合、一部コンテナは正常に起動しません。また、起動はしても本来の動作とは違った挙動をするため、必ず環境変数を設定してください。
    - 本番環境で使用するために設定するパスワードやログインユーザー名は、必ず推測されにくい値を設定してください。

4. PowerShell上で `docker compose up --build` コマンドを実行
    - このコマンドでコンテナがビルドを開始します。使用しているネットワークの環境によってはビルドに時間がかかる可能性がありますが、コーヒーでも飲みながら気長に待っていてください。ビルドが完了すると自動でコンテナが起動します。

5. コンテナの起動を確認する
    - Docker Desktop上に正常に起動したコンテナは緑色で表示されます。また、起動中はPowerShellに大量の文字が流れますが、その流れが落ち着いたら起動完了です。

### ポートの競合
様々なWebアプリを開発していると、意図せずポートの競合が発生してしまいます。だいたいWeb周りのポートがよく競合を起こすため、本プロジェクトではWebサーバーのポートを8000番へ変更しています。Flaskがデフォルトで使用するポートは5000番なので、コンテナ内では5000番を利用し、ホスト機の8000番ポートを使用します。この設定はcompose.ymlファイルに記述されているため、もし8000番で競合が発生した場合は適宜ポートを変更してください。
> [!NOTE]
> 変更するポートはホスト側のみにしてください。コンテナ側のポートを変更する場合はFlaskの設定を変更する必要があります。

### Minecraftクライアントでサーバーにアクセスする
サーバーのビルドが成功すれば、あとは仲間と共に遊ぶだけです。ここではクライアントからアクセスする方法を説明します。
> [!NOTE]
> 本サーバーはMinecraftのJava Editionを対象としています。
##### サーバーホスト機からアクセス
この場合が一番簡単にアクセスできます。Minecraftクライアントを起動し、マルチプレイメニューのサーバー情報入力欄にあるアドレス項目に `localhost` と入力すればアクセス可能です。
##### サーバーが起動しているローカルネットワーク内のPCからアクセス
少し面倒です。起動しているサーバーのIPアドレスを調べ、その値をアドレス項目に入力してください。IPアドレスの調べ方はWindowsなら `ipconfig` コマンドで調べられます。Macは自身で調べてください。
##### ネットワークの外部からアクセス
一番面倒です。以下の手順でアクセスできます。
1. サーバーのポートを開放
    - コンテナのポートは開放されていますが、ホストサーバーのポートは開放されていません。[Windowsでポートを開放する](https://www.fmworld.net/cs/azbyclub/qanavi/jsp/qacontents.jsp?PID=0111-2966)を参考に実施してください。なお、ホストOSにUbuntuを利用している場合はポート開放の必要はありません。
2. 使用しているルーターのポートフォワーディング設定を変更
3. グローバルIPアドレスを調べる
    - こちらのサイトからグローバルIPアドレスを検索できます。
4. 調べたアドレスをMinecraftクライアントのアドレス欄に入力  
この方法で外部からアクセスが可能になります。ポート開放作業は設定を間違えると外部から攻撃を受けてしまうリスクがあるので、必ず調べてから実行しましょう。

### 参考したソース
[RCONをマインクラフトで利用する](https://qiita.com/h_tyokinuhata/items/85d855f88d5d33c21949)  


  
